#!/bin/bash

# ENV
export FQDN
export DOMAIN
FQDN="$(hostname --fqdn)"
DOMAIN="$(hostname --domain)"

if [ -z "$DBPASS" ]; then
  echo "Mariadb database password must be set !"
  exit 1
fi

# SSL certificates
LETS_ENCRYPT_LIVE_PATH="/etc/letsencrypt/live/$FQDN"

if [ -d "$LETS_ENCRYPT_LIVE_PATH" ]; then
  FULLCHAIN="$LETS_ENCRYPT_LIVE_PATH/fullchain.pem"
  CAFILE="$LETS_ENCRYPT_LIVE_PATH/chain.pem"
  CERTFILE="$LETS_ENCRYPT_LIVE_PATH/cert.pem"
  KEYFILE="$LETS_ENCRYPT_LIVE_PATH/privkey.pem"
else
  CERTFILE=/var/mail/ssl/selfsigned/cert.pem
  KEYFILE=/var/mail/ssl/selfsigned/privkey.pem

  if [ ! -e $CERTFILE ] || [ ! -e $KEYFILE ]; then
    mkdir -p /var/mail/ssl/selfsigned/
    openssl req -new -newkey rsa:4096 -days 3658 -sha256 -nodes -x509 \
      -subj "/C=FR/ST=France/L=Paris/O=Mailserver certificate/OU=Mail/CN=*.${DOMAIN}/emailAddress=admin@${DOMAIN}" \
      -keyout $KEYFILE \
      -out $CERTFILE
  fi
fi

# Diffie-Hellman parameters
if [ ! -e "/var/mail/ssl/dhparams/dh2048.pem" ] || [ ! -e "/var/mail/ssl/dhparams/dh512.pem" ]; then
  mkdir -p /var/mail/ssl/dhparams/
  openssl dhparam -out /var/mail/ssl/dhparams/dh2048.pem 2048
  openssl dhparam -out /var/mail/ssl/dhparams/dh512.pem 512
fi

# Folder and permissions
mkdir -p /var/mail/vhosts/"${DOMAIN}"
groupadd -g "$VMAILGID" vmail
useradd -g vmail -u "$VMAILUID" vmail -d /var/mail
chown -R vmail:vmail /var/mail
chown -R vmail:dovecot /etc/dovecot
chmod -R o-rwx /etc/dovecot

# Sieve
mkdir /var/mail/sieve &> /dev/null
cat > /var/mail/sieve/default.sieve <<EOF
require ["fileinto"];

if header :contains "Subject" "*****SPAM*****" {

    fileinto "Junk";

}
EOF
chown -R vmail:vmail /var/mail/sieve
sievec /var/mail/sieve/default.sieve

# Logging
mkdir /var/log/mail &> /dev/null
rm /var/log/mail.log &> /dev/null
touch /var/log/mail/mail.log
ln -s /var/log/mail/mail.log /var/log/mail.log

# Dovecot mountpoints ignoring
doveadm mount add /var/lib/dovecot ignore
doveadm mount add /etc/opendkim/keys ignore
doveadm mount add /etc/letsencrypt ignore
doveadm mount add /var/log/mail ignore

# Postfix
if [ -d "$LETS_ENCRYPT_LIVE_PATH" ]; then
  sed -i "s|<CAFILE>|${CAFILE}|g" /etc/postfix/main.cf
else
  sed -i '/^\(smtp_tls_CAfile\|smtpd_tls_CAfile\)/s/^/#/' /etc/postfix/main.cf
fi

sed -i -e "s/<FQDN>/${FQDN}/g" \
       -e "s/<DOMAIN>/${DOMAIN}/g" \
       -e "s/<UID>/$VMAILUID/g" \
       -e "s/<GID>/$VMAILGID/g" \
       -e "s|<CERTFILE>|${CERTFILE}|g" \
       -e "s|<KEYFILE>|${KEYFILE}|g" /etc/postfix/main.cf

sed -i -e "s/<DBHOST>/${DBHOST}/g" \
       -e "s/<DBNAME>/${DBNAME}/g" \
       -e "s/<DBUSER>/${DBUSER}/g" \
       -e "s/<DBPASS>/${DBPASS}/g" /etc/postfix/mysql/*.cf

# Dovecot
sed -i -e "s/<UID>/$VMAILUID/g" \
       -e "s/<GID>/$VMAILGID/g" /etc/dovecot/conf.d/10-mail.conf

sed -i -e "s/<DBHOST>/${DBHOST}/g" \
       -e "s/<DBNAME>/${DBNAME}/g" \
       -e "s/<DBUSER>/${DBUSER}/g" \
       -e "s/<DBPASS>/${DBPASS}/g" /etc/dovecot/dovecot-sql.conf.ext

if [ -d "$LETS_ENCRYPT_LIVE_PATH" ]; then
  sed -i -e "s|<FULLCHAIN>|${FULLCHAIN}|g" \
         -e "s|<KEYFILE>|${KEYFILE}|g" /etc/dovecot/conf.d/10-ssl.conf
else
  sed -i -e "s|<FULLCHAIN>|${CERTFILE}|g" \
         -e "s|<KEYFILE>|${KEYFILE}|g" /etc/dovecot/conf.d/10-ssl.conf
fi

sed -i "s/<DOMAIN>/${DOMAIN}/g" /etc/dovecot/conf.d/20-lmtp.conf

# OpenDKIM
sed -i "s/<DOMAIN>/${DOMAIN}/g" /etc/opendkim/KeyTable
sed -i "s/<DOMAIN>/${DOMAIN}/g" /etc/opendkim/SigningTable
sed -i "s/<DOMAIN>/${DOMAIN}/g" /etc/opendkim/TrustedHosts
sed -i "s/<FQDN>/${FQDN}/g" /etc/opendkim/opendkim.conf

# OpenDMARC
sed -i "s/<FQDN>/${FQDN}/g" /etc/opendmarc/opendmarc.conf

# Spamassassin
sed -i "s/<DOMAIN>/${DOMAIN}/g" /etc/spamassassin/local.cf

# Amavis
sed -i "s/<FQDN>/${FQDN}/g" /etc/amavis/conf.d/05-node_id

# Mailname
sed -i "s/<FQDN>/${FQDN}/g" /etc/mailname

# RUN !
/usr/bin/supervisord -c /etc/supervisor/supervisord.conf
